<!DOCTYPE html><html lang="zh-CN"><head>    <meta charset="UTF-8">    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <title>圆角控制条歌词播放器</title>    <style>        @font-face {            font-family: 'XingShu';            src: url('https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&display=swap');            font-display: swap;        }                body {            margin: 0;            padding: 0;            height: 100vh;            display: flex;            justify-content: center;            align-items: center;            font-family: 'XingShu', 'Ma Shan Zheng', cursive;            overflow: hidden;            color: white;            text-shadow: 0 0 5px rgba(0, 0, 0, 0.8);            background-color: rgba(0, 0, 0, 0.7);        }        .import-area {            position: absolute;            top: 50%;            left: 50%;            transform: translate(-50%, -50%);            text-align: center;            z-index: 100;            background: rgba(0, 0, 0, 0.8);            padding: 30px;            border-radius: 20px;            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);            border: 2px dashed rgba(255, 255, 255, 0.3);            transition: all 0.3s ease;            max-width: 80%;        }                .import-area:hover {            border-color: rgba(255, 255, 255, 0.6);        }                .import-title {            font-size: 2em;            margin-bottom: 20px;        }                .import-buttons {            display: flex;            justify-content: center;            gap: 15px;            flex-wrap: wrap;        }                .import-btn {            background: rgba(255, 255, 255, 0.1);            border: none;            color: white;            padding: 12px 20px;            border-radius: 30px;            font-size: 1.1em;            cursor: pointer;            transition: all 0.2s;            min-width: 150px;        }                .import-btn:hover {            background: rgba(255, 255, 255, 0.2);            transform: translateY(-2px);        }        .background {            position: fixed;            top: 0;            left: 0;            width: 100%;            height: 100%;            background-size: cover;            background-position: center;            filter: blur(15px) brightness(0.7);            z-index: -1;            transform: scale(1.1);            transition: background-image 0.5s ease;        }        .cover-container {            position: fixed;            top: 20%;            left: 50%;            transform: translateX(-50%);            text-align: center;            z-index: 0;            transition: all 0.5s ease;            opacity: 1;        }        .cover-display {            width: 250px;            height: 250px;            border-radius: 20px;            background-size: cover;            background-position: center;            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);            margin-bottom: 20px;        }        .song-title {            font-size: 1.8em;            font-weight: bold;            text-align: center;            margin-top: 10px;            opacity: 0.9;        }        .lyrics-container {            text-align: center;            max-width: 80%;            cursor: pointer;            margin-bottom: 80px;            transition: opacity 0.5s ease;            position: relative;            z-index: 1;            opacity: 0;        }        .current-line {            font-size: 3em;            font-weight: bold;            margin: 20px 0;            transition: opacity 0.2s ease;            min-height: 1.5em;            position: relative;            overflow: hidden;        }        .char-animation {            display: inline-block;            opacity: 0;            transform: translateY(20px);            animation: charAppear 0.3s forwards;            white-space: pre;        }        @keyframes charAppear {            to {                opacity: 1;                transform: translateY(0);            }        }        .progress-bar {            position: fixed;            bottom: 80px;            left: 0;            width: 100%;            height: 5px;            background-color: rgba(255, 255, 255, 0.3);            cursor: pointer;            opacity: 0;            transition: opacity 0.3s;        }        .progress {            height: 100%;            background-color: #1db954;            width: 0%;            transition: width 0.1s linear;            position: relative;            z-index: 2;        }        .progress-bar-bg {            position: absolute;            top: 0;            left: 0;            width: 100%;            height: 100%;            z-index: 1;        }        .control-bar {            position: fixed;            bottom: 20px;            left: 50%;            transform: translateX(-50%);            background-color: rgba(0, 0, 0, 0.7);            border-radius: 25px;            padding: 10px 20px;            display: flex;            align-items: center;            transition: all 0.3s ease;            max-width: 90%;            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);            opacity: 0;        }        .compact-controls {            display: flex;            align-items: center;            min-width: 200px;        }        .expanded-controls {            display: none;            align-items: center;            margin-left: 15px;        }        .control-bar.expanded {            padding: 15px 25px;        }        .control-bar.expanded .compact-controls {            min-width: auto;        }        .control-bar.expanded .expanded-controls {            display: flex;        }        .song-info {            white-space: nowrap;            margin: 0 15px;            font-size: 1.1em;            font-weight: bold;            min-width: 100px;            text-align: center;        }        .play-pause {            background: rgba(255, 255, 255, 0.1);            border: none;            color: white;            font-size: 1.3em;            cursor: pointer;            width: 40px;            height: 40px;            display: flex;            align-items: center;            justify-content: center;            border-radius: 50%;            transition: all 0.2s;        }        .play-pause:hover {            background: rgba(255, 255, 255, 0.2);        }        .settings-icon {            margin-left: 10px;            cursor: pointer;            width: 40px;            height: 40px;            display: flex;            align-items: center;            justify-content: center;            border-radius: 50%;            transition: all 0.3s ease;        }        .settings-icon:hover {            background: rgba(255, 255, 255, 0.2);            transform: rotate(30deg);        }        .control-group {            display: flex;            align-items: center;            margin: 0 15px;        }        .control-label {            font-size: 0.8em;            margin-right: 10px;            min-width: 40px;        }        .control-slider {            width: 100px;        }        .control-value {            min-width: 40px;            text-align: center;            font-size: 0.8em;            font-family: monospace;            margin-left: 8px;        }        .player-ready .import-area {            opacity: 0;            pointer-events: none;            transform: translate(-50%, -50%) scale(0.9);        }                .player-ready .cover-container,        .player-ready .lyrics-container,        .player-ready .control-bar,        .player-ready .progress-bar {            opacity: 1;        }                .playing .cover-container {            opacity: 0;            transform: translate(-50%, -50px);        }                .paused .lyrics-container {            opacity: 0;            pointer-events: none;        }                .paused .cover-container {            opacity: 1;            transform: translate(-50%, 0);        }    </style></head><body>    <div class="import-area" id="importArea">        <div class="import-title">导入音乐文件</div>        <div class="import-buttons">            <button class="import-btn" id="importAudioBtn">导入音频</button>            <button class="import-btn" id="importLyricsBtn">导入歌词</button>            <button class="import-btn" id="importCoverBtn">导入封面</button>        </div>    </div>        <div class="background" id="background"></div>    <div class="cover-container" id="coverContainer">        <div class="cover-display" id="coverDisplay"></div>        <div class="song-title" id="songTitle"></div>    </div>        <div class="lyrics-container" id="lyricsContainer">        <div class="current-line" id="currentLine">准备播放</div>    </div>        <div class="progress-bar" id="progressBar">        <div class="progress" id="progress"></div>        <div class="progress-bar-bg" id="progressBarBg"></div>    </div>        <div class="control-bar" id="controlBar">        <div class="compact-controls">            <button class="play-pause" id="playPauseBtn">▶</button>            <div class="song-info" id="songInfo">无歌曲</div>            <div class="settings-icon" id="settingsIcon">⚙️</div>        </div>                <div class="expanded-controls">            <div class="control-group">                <div class="control-label">音量</div>                <input type="range" min="0", max="1" step="0.01" value="0.7" class="control-slider" id="volumeSlider">                <div class="control-value" id="volumeValue">70%</div>            </div>                        <div class="control-group">                <div class="control-label">偏移</div>                <input type="range" min="-5" max="5" step="0.1" value="3" class="control-slider" id="offsetSlider">                <div class="control-value" id="offsetValue">3.0s</div>            </div>        </div>    </div>        <input type="file" id="audioInput" accept="audio/*" style="display: none;">    <input type="file" id="lyricsInput" accept=".lrc,.txt" style="display: none;">    <input type="file" id="coverInput" accept="image/*" style="display: none;">        <audio id="audioPlayer"></audio>        <script>        // 获取DOM元素        const audioPlayer = document.getElementById('audioPlayer');        const currentLine = document.getElementById('currentLine');        const progress = document.getElementById('progress');        const playPauseBtn = document.getElementById('playPauseBtn');        const songInfo = document.getElementById('songInfo');        const songTitle = document.getElementById('songTitle');        const background = document.getElementById('background');        const coverDisplay = document.getElementById('coverDisplay');        const coverContainer = document.getElementById('coverContainer');        const lyricsContainer = document.getElementById('lyricsContainer');        const controlBar = document.getElementById('controlBar');        const progressBar = document.getElementById('progressBar');        const progressBarBg = document.getElementById('progressBarBg');        const settingsIcon = document.getElementById('settingsIcon');        const volumeSlider = document.getElementById('volumeSlider');        const volumeValue = document.getElementById('volumeValue');        const offsetSlider = document.getElementById('offsetSlider');        const offsetValue = document.getElementById('offsetValue');        const body = document.body;        const importArea = document.getElementById('importArea');        const importAudioBtn = document.getElementById('importAudioBtn');        const importLyricsBtn = document.getElementById('importLyricsBtn');        const importCoverBtn = document.getElementById('importCoverBtn');        const audioInput = document.getElementById('audioInput');        const lyricsInput = document.getElementById('lyricsInput');        const coverInput = document.getElementById('coverInput');                // 歌词数据        let lyrics = [];        let currentLyricIndex = -1;        let lyricTimeout = null;        let lastUpdateTime = 0;        let lyricOffset = 3; // 默认歌词偏移3秒        let autoCollapseTimer = null;        let dominantColor = '#1db954'; // 默认进度条颜色        let currentSongName = '';        let hasAudio = false;        let hasLyrics = false;        let hasCover = false;        let isPlaying = false;                // 检查是否完成初始化        function checkInitStatus() {            if (hasAudio && hasLyrics && hasCover) {                body.classList.add('player-ready');                currentLine.textContent = "准备播放";                document.getElementById('currentLine').style.opacity = 1;            }        }                // 修复LRC解析问题        function parseLyrics(text) {            lyrics = [];            const lines = text.split('\n');            const timeRegex = /\[(\d+):(\d+)\.(\d+)\]/g;                        lines.forEach(line => {                const matches = [...line.matchAll(timeRegex)];                if (matches.length > 0) {                    const text = line.replace(timeRegex, '').trim();                    if (text) {                        matches.forEach(match => {                            const minutes = parseInt(match[1]);                            const seconds = parseInt(match[2]);                            const milliseconds = parseInt(match[3]);                            const time = minutes * 60 + seconds + milliseconds / 100;                            // 替换HTML实体为正常空格                            const cleanText = text.replace(/&nbsp;/g, ' ');                            lyrics.push({ time, text: cleanText });                        });                    }                }            });                        // 按时间排序            lyrics.sort((a, b) => a.time - b.time);                        // 计算每句歌词的持续时间            for (let i = 0; i < lyrics.length; i++) {                lyrics[i].duration = (i < lyrics.length - 1)                     ? (lyrics[i+1].time - lyrics[i].time)                    : 3; // 最后一句显示3秒            }                        hasLyrics = true;            checkInitStatus();        }                // 逐个字符动画显示歌词        function animateLyrics(text) {            currentLine.innerHTML = '';            const chars = [...text];            chars.forEach((char, index) => {                const span = document.createElement('span');                span.className = 'char-animation';                span.textContent = char.replace(/ /g, '\u00A0'); // 替换空格为不换行空格                span.style.animationDelay = `${index * 0.05}s`;                currentLine.appendChild(span);            });        }                // 从图片获取主色调        function getDominantColor(imageUrl, callback) {            const img = new Image();            img.crossOrigin = "Anonymous";            img.src = imageUrl;                        img.onload = function() {                const canvas = document.createElement('canvas');                const ctx = canvas.getContext('2d');                canvas.width = 50;                canvas.height = 50;                ctx.drawImage(img, 0, 0, 50, 50);                                const imageData = ctx.getImageData(0, 0, 50, 50);                const data = imageData.data;                let r = 0, g = 0, b = 0;                                for (let i = 0; i < data.length; i += 4) {                    r += data[i];                    g += data[i + 1];                    b += data[i + 2];                }                                r = Math.round(r / (data.length / 4));                g = Math.round(g / (data.length / 4));                b = Math.round(b / (data.length / 4));                                dominantColor = `rgb(${r}, ${g}, ${b})`;                callback(dominantColor);            };                        img.onerror = function() {                dominantColor = '#1db954'; // 默认颜色                callback(dominantColor);            };        }                // 精确更新歌词显示（考虑偏移时间）        function updateLyrics(currentTime) {            // 应用偏移时间            const adjustedTime = currentTime + lyricOffset;                        // 避免频繁更新            if (Math.abs(adjustedTime - lastUpdateTime) < 0.1) return;            lastUpdateTime = adjustedTime;                        // 清除之前的定时器            if (lyricTimeout) {                clearTimeout(lyricTimeout);                lyricTimeout = null;            }                        // 找到当前应该显示的歌词            let newIndex = -1;            for (let i = lyrics.length - 1; i >= 0; i--) {                if (adjustedTime >= lyrics[i].time) {                    newIndex = i;                    break;                }            }                        // 如果找到新的歌词            if (newIndex !== -1) {                // 如果是新的歌词或需要重新显示                if (newIndex !== currentLyricIndex || currentLine.style.opacity === '0') {                    currentLyricIndex = newIndex;                    animateLyrics(lyrics[currentLyricIndex].text);                    currentLine.style.opacity = 1;                                        // 设置歌词消失时间                    const endTime = lyrics[currentLyricIndex].time + lyrics[currentLyricIndex].duration;                    const remainingTime = endTime - adjustedTime;                                        if (remainingTime > 0) {                        lyricTimeout = setTimeout(() => {                            currentLine.style.opacity = 0;                        }, remainingTime * 1000);                    }                }            } else {                // 没有歌词需要显示                if (currentLine.style.opacity !== '0') {                    currentLine.style.opacity = 0;                }            }        }                // 切换播放状态UI        function togglePlayState(playing) {            isPlaying = playing;            if (playing) {                body.classList.add('playing');                body.classList.remove('paused');                lyricsContainer.style.opacity = 1;                coverContainer.style.opacity = 0;                coverContainer.style.transform = 'translate(-50%, -50px)';            } else {                body.classList.remove('playing');                body.classList.add('paused');                lyricsContainer.style.opacity = 0;                coverContainer.style.opacity = 1;                coverContainer.style.transform = 'translate(-50%, 0)';            }        }                // 切换控制面板展开状态        function toggleControls(expand) {            if (expand === undefined) {                expand = !controlBar.classList.contains('expanded');            }                        if (expand) {                controlBar.classList.add('expanded');                startAutoCollapseTimer();            } else {                controlBar.classList.remove('expanded');                clearTimeout(autoCollapseTimer);            }        }                // 开始自动收起计时器        function startAutoCollapseTimer() {            clearTimeout(autoCollapseTimer);            autoCollapseTimer = setTimeout(() => {                toggleControls(false);            }, 5000); // 5秒后自动收起        }                // 重置自动收起计时器        function resetAutoCollapseTimer() {            if (controlBar.classList.contains('expanded')) {                startAutoCollapseTimer();            }        }                // 修复进度条拖动问题        function setupProgressBar() {            let isDragging = false;                        progressBarBg.addEventListener('mousedown', (e) => {                isDragging = true;                updateProgress(e);                                // 监听鼠标移动事件                document.addEventListener('mousemove', updateProgress);                                // 监听鼠标松开事件                document.addEventListener('mouseup', () => {                    isDragging = false;                    document.removeEventListener('mousemove', updateProgress);                });            });                        function updateProgress(e) {                if (!isDragging && e.type !== 'mousedown') return;                                const rect = progressBar.getBoundingClientRect();                const percent = Math.min(1, Math.max(0, (e.clientX - rect.left) / rect.width));                                if (audioPlayer.src) {                    audioPlayer.currentTime = percent * audioPlayer.duration;                    progress.style.width = `${percent * 100}%`;                                        // 强制更新当前歌词显示                    currentLyricIndex = -1;                    if (!audioPlayer.paused) {                        updateLyrics(audioPlayer.currentTime);                    }                }            }        }                // 初始化事件监听        function initEventListeners() {            // 导入音频按钮            importAudioBtn.addEventListener('click', () => {                audioInput.click();            });                        // 导入歌词按钮            importLyricsBtn.addEventListener('click', () => {                lyricsInput.click();            });                        // 导入封面按钮            importCoverBtn.addEventListener('click', () => {                coverInput.click();            });                        // 导入音频            audioInput.addEventListener('change', (e) => {                const file = e.target.files[0];                if (file) {                    currentSongName = file.name.replace(/\.[^/.]+$/, "");                    songInfo.textContent = currentSongName;                    songTitle.textContent = currentSongName;                    audioPlayer.src = URL.createObjectURL(file);                    hasAudio = true;                    checkInitStatus();                }            });                        // 导入歌词            lyricsInput.addEventListener('change', (e) => {                const file = e.target.files[0];                if (file) {                    const reader = new FileReader();                    reader.onload = (e) => {                        parseLyrics(e.target.result);                    };                    reader.readAsText(file);                }            });                        // 导入封面            coverInput.addEventListener('change', (e) => {                const file = e.target.files[0];                if (file) {                    const url = URL.createObjectURL(file);                    background.style.backgroundImage = `url(${url})`;                    coverDisplay.style.backgroundImage = `url(${url})`;                    hasCover = true;                    checkInitStatus();                                        // 获取主色调并设置进度条颜色                    getDominantColor(url, (color) => {                        document.getElementById('progress').style.backgroundColor = color;                    });                }            });                        // 播放/暂停控制            playPauseBtn.addEventListener('click', () => {                if (audioPlayer.paused) {                    audioPlayer.play().then(() => {                        playPauseBtn.textContent = '⏸';                        togglePlayState(true);                    }).catch(e => {                        console.error("播放失败:", e);                    });                } else {                    audioPlayer.pause();                    playPauseBtn.textContent = '▶';                    togglePlayState(false);                }            });                        // 音量控制            volumeSlider.addEventListener('input', (e) => {                const volume = e.target.value;                audioPlayer.volume = volume;                volumeValue.textContent = `${Math.round(volume * 100)}%`;                resetAutoCollapseTimer();            });                        // 歌词偏移控制            offsetSlider.addEventListener('input', (e) => {                lyricOffset = parseFloat(e.target.value);                offsetValue.textContent = lyricOffset.toFixed(1) + 's';                resetAutoCollapseTimer();                                // 强制更新当前歌词显示                currentLyricIndex = -1;                if (!audioPlayer.paused) {                    updateLyrics(audioPlayer.currentTime);                }            });                        // 设置进度条拖动逻辑            setupProgressBar();                        // 更新时间显示            audioPlayer.addEventListener('timeupdate', () => {                if (audioPlayer.src && audioPlayer.duration) {                    const percent = (audioPlayer.currentTime / audioPlayer.duration) * 100;                    progress.style.width = `${percent}%`;                    updateLyrics(audioPlayer.currentTime);                }            });                        // 歌曲结束            audioPlayer.addEventListener('ended', () => {                playPauseBtn.textContent = '▶';                currentLine.style.opacity = 1;                currentLine.textContent = "播放结束";                togglePlayState(false);            });                        // 设置图标点击            settingsIcon.addEventListener('click', (e) => {                e.stopPropagation();                toggleControls();            });                        // 点击控制面板外区域收起面板            document.addEventListener('click', (e) => {                if (!controlBar.contains(e.target) && !e.target.classList.contains('settings-icon')) {                    toggleControls(false);                }            });                        // 控制面板悬停时暂停自动收起            controlBar.addEventListener('mouseenter', () => {                clearTimeout(autoCollapseTimer);            });                        controlBar.addEventListener('mouseleave', () => {                if (controlBar.classList.contains('expanded')) {                    startAutoCollapseTimer();                }            });                        // 拖放功能            document.addEventListener('dragover', (e) => {                e.preventDefault();                importArea.style.borderColor = 'rgba(255, 255, 255, 0.8)';            });                        document.addEventListener('dragleave', () => {                importArea.style.borderColor = 'rgba(255, 255, 255, 0.3)';            });                        document.addEventListener('drop', (e) => {                e.preventDefault();                importArea.style.borderColor = 'rgba(255, 255, 255, 0.3)';                                const files = e.dataTransfer.files;                if (files.length > 0) {                    const file = files[0];                    const ext = file.name.split('.').pop().toLowerCase();                                        if (['mp3', 'wav', 'ogg', 'm4a'].includes(ext)) {                        audioInput.files = files;                        const event = new Event('change');                        audioInput.dispatchEvent(event);                    } else if (['lrc', 'txt'].includes(ext)) {                        lyricsInput.files = files;                        const event = new Event('change');                        lyricsInput.dispatchEvent(event);                    } else if (['jpg', 'jpeg', 'png', 'gif'].includes(ext)) {                        coverInput.files = files;                        const event = new Event('change');                        coverInput.dispatchEvent(event);                    }                }            });        }                // 初始化        initEventListeners();        audioPlayer.volume = volumeSlider.value;        volumeValue.textContent = `${Math.round(volumeSlider.value * 100)}%`;        offsetValue.textContent = '3.0s';        offsetSlider.value = 3;        lyricOffset = 3;        togglePlayState(false);    </script></body></html>